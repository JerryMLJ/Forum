<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘ä»¬çš„ç§˜å¯†åŸºåœ°</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; background-color: #2f3136; color: #dcddde; display: flex; overflow: hidden; }

        /* --- å¸ƒå±€å®¹å™¨ --- */
        .container { display: flex; width: 100%; height: 100%; }

        /* --- 1. å·¦ä¾§è¾¹æ  (æœªæ¥æ‰©å±•åŒº) --- */
        .sidebar {
            width: 260px;
            background-color: #202225;
            display: flex;
            flex-direction: column;
            padding: 20px 10px;
            border-right: 1px solid #1e1f22;
        }
        .sidebar-title { font-weight: bold; color: #fff; margin-bottom: 20px; padding-left: 10px; font-size: 1.1em; }
        .channel-list { list-style: none; }
        .channel-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            color: #8e9297;
            transition: 0.2s;
        }
        .channel-item:hover, .channel-item.active { background-color: #393c43; color: #fff; }
        .channel-item::before { content: "# "; color: #6d6f78; }

        /* --- 2. ä¸»èŠå¤©çª—å£ --- */
        .main-chat { flex: 1; display: flex; flex-direction: column; background-color: #36393f; position: relative; }
        
        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .chat-header {
            height: 50px;
            border-bottom: 1px solid #26272d;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-weight: bold;
            color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* æ¶ˆæ¯æ»šåŠ¨åŒº */
        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto; /* å…è®¸ä¸Šä¸‹æ»šåŠ¨ */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
        .message { display: flex; flex-direction: column; }
        .message-info { font-size: 0.8em; color: #a3a6aa; margin-bottom: 4px; }
        .username { font-weight: bold; color: #fff; margin-right: 8px; cursor: pointer; }
        .username:hover { text-decoration: underline; }
        .message-content {
            line-height: 1.5;
            color: #dcddde;
            word-wrap: break-word; /* é˜²æ­¢é•¿å•è¯æ’‘ç ´ */
        }
        
        /* è‡ªå·±çš„æ¶ˆæ¯ç¨å¾®ç‰¹åˆ«ä¸€ç‚¹ (æ¨¡æ‹Ÿ) */
        .message.self { align-items: flex-end; }
        .message.self .message-content {
            background-color: #0084ff;
            color: white;
            padding: 8px 12px;
            border-radius: 12px 12px 0 12px;
            display: inline-block;
        }

        /* --- 3. åº•éƒ¨è¾“å…¥æ¡† --- */
        .input-area {
            padding: 20px;
            background-color: #36393f;
        }
        .input-wrapper {
            background-color: #40444b;
            border-radius: 8px;
            padding: 0 15px;
            display: flex;
            align-items: center;
        }
        #msg-input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 15px 0;
            color: #fff;
            outline: none;
            font-size: 1rem;
        }
        #send-btn {
            background: none;
            border: none;
            color: #b9bbbe;
            cursor: pointer;
            font-weight: bold;
            padding: 10px;
        }
        #send-btn:hover { color: #fff; }

    </style>
</head>
<body>

<div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#2f3136; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div style="background:#36393f; padding:40px; border-radius:8px; width:320px; text-align:center;">
        <h2 style="color:white; margin-bottom:20px;">æ¬¢è¿å›æ¥</h2>
        <input type="text" id="auth-user" placeholder="ç”¨æˆ·å" style="width:100%; padding:10px; margin-bottom:10px; border-radius:4px; border:none;">
        <input type="password" id="auth-pass" placeholder="å¯†ç " style="width:100%; padding:10px; margin-bottom:20px; border-radius:4px; border:none;">
        <button onclick="handleAuth('login')" style="width:100%; padding:10px; background:#5865f2; color:white; border:none; border-radius:4px; cursor:pointer;">ç™»å½•</button>
        <p style="margin-top:15px; font-size:0.8em;">æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="handleAuth('register')" style="color:#00aff4;">ç«‹å³æ³¨å†Œ</a></p>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-title">ğŸ® æœ‹å‹ä»¬çš„åŸºåœ°</div>
        <ul class="channel-list">
            <li class="channel-item active">é—²èŠå¤§å…</li>
            <li class="channel-item">æ¸¸æˆç»„é˜Ÿ</li>
            <li class="channel-item">AI æœºå™¨äºº (æœªå¼€å‘)</li>
            <li class="channel-item">ä½ ç”»æˆ‘çŒœ (æœªå¼€å‘)</li>
        </ul>
    </div>

    <div class="main-chat">
        <div class="chat-header"># é—²èŠå¤§å…</div>
        
        <div class="messages-area" id="messages-area">
            <div class="message">
                <div class="message-info"><span class="username">ç³»ç»ŸåŠ©æ‰‹</span> 12:00</div>
                <div class="message-content">æ¬¢è¿æ¥åˆ°ä½ çš„æ–°è®ºå›ï¼è¿™é‡Œç°åœ¨åªæœ‰å‰ç«¯ç•Œé¢å“¦ã€‚</div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="msg-input" placeholder="å‘é€æ¶ˆæ¯ç»™ #é—²èŠå¤§å…" autocomplete="off">
                <button id="send-btn">å‘é€</button>
            </div>
        </div>
    </div>
</div>
<script src="/socket.io/socket.io.js"></script>

<script>
    var socket = io(); // 1. æ‹¨é€šæœåŠ¡å™¨çš„â€œç”µè¯ä¸“çº¿â€

    let myName = localStorage.getItem('chat-username');

    // å¦‚æœæœ¬åœ°æœ‰å­˜ç”¨æˆ·åï¼Œç›´æ¥éšè—ç™»å½•å±‚ï¼ˆç®€å•å¤„ç†ï¼Œè¿›é˜¶å¯ä»¥ç”¨ Tokenï¼‰
    if (myName) {
        document.getElementById('login-overlay').style.display = 'none';
    }

    async function handleAuth(type) {
        const username = document.getElementById('auth-user').value;
        const password = document.getElementById('auth-pass').value;

        if (!username || !password) return alert("è¯·å¡«æ»¡ä¿¡æ¯");

        const response = await fetch(`/${type}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const result = await response.json();

        if (response.ok) {
            alert(type === 'login' ? "ç™»å½•æˆåŠŸï¼" : "æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
            if (type === 'login') {
                localStorage.setItem('chat-username', result.username);
                location.reload(); // åˆ·æ–°é¡µé¢è¿›å…¥èŠå¤©å®¤
            }
        } else {
            alert(result.error);
        }
    }
    const input = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');
    const msgArea = document.getElementById('messages-area');

    // 2. å‘é€æ¶ˆæ¯ç»™æœåŠ¡å™¨
    function sendMessage() {
        if (input.value.trim()) {
            console.log('æ­£åœ¨å‘é€:', input.value);
            // å‘é€ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«æ˜µç§°å’Œå†…å®¹ï¼ˆä»¥åè¿˜å¯ä»¥åŠ å¤´åƒã€æ—¶é—´ï¼‰
            socket.emit('chat message', {
                user: myName,
                text: input.value
            });
            input.value = '';
            input.focus();
        }
    }

    sendBtn.onclick = sendMessage;
    input.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };

    // 3. æ ¸å¿ƒï¼šç›‘å¬æœåŠ¡å™¨å¹¿æ’­å›æ¥çš„æ¶ˆæ¯
    socket.on('chat message', function(data) {
        console.log('æ”¶åˆ°æœåŠ¡å™¨å¹¿æ’­:', data);
        // åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±å‘çš„ï¼ˆè¿™é‡Œæš‚æ—¶ç”¨ç®€å•é€»è¾‘åˆ¤æ–­ï¼Œä»¥åå¯ä»¥åŠ  IDï¼‰
        const isSelf = data.user === myName;
        addMessageToUI(data.user, data.text, isSelf);
    });

    // æŠŠæ¶ˆæ¯æ¸²æŸ“åˆ°é¡µé¢ä¸Šçš„å‡½æ•°
    function addMessageToUI(user, text, isSelf) {
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const msgDiv = document.createElement('div');
        msgDiv.className = isSelf ? 'message self' : 'message';
        
        msgDiv.innerHTML = `
            <div class="message-info"><span class="username">${user}</span> ${time}</div>
            <div class="message-content">${text}</div>
        `;
        
        msgArea.appendChild(msgDiv);
        msgArea.scrollTop = msgArea.scrollHeight;
    }
</script>


</body>
</html>